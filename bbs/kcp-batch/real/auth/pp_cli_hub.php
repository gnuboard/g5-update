<?php
    /* ============================================================================== */
    /* =   PAGE : 인증 요청 및 결과 처리 PAGE                                       = */
    /* = -------------------------------------------------------------------------- = */
    /* =   Copyright (c)  2013   KCP Inc.   All Rights Reserverd.                   = */
    /* ============================================================================== */


    /* ============================================================================== */
    /* =   01. 인증 데이터 셋업 (업체에 맞게 수정)                                  = */
    /* = -------------------------------------------------------------------------- = */
    require "pp_cli_hub_lib.php";                             // library [수정불가]
    include "../../cfg/site_conf_inc.php";                    // 환경 설정 파일
    /* ============================================================================== */


    /* ============================================================================== */
    /* =   02. 인증 요청 정보 설정                                                  = */
    /* = -------------------------------------------------------------------------- = */
    $req_tx      = $_POST[ "req_tx"      ];                  // 요청 종류
    $tran_cd     = $_POST[ "tran_cd"     ];                  // 처리 종류
    $cust_ip     = getenv( "REMOTE_ADDR" );                  // 요청 IP (옵션값)
    /* = -------------------------------------------------------------------------- = */
    $pay_method  = $_POST[ "pay_method"  ];                  // 결제 방법
    $ordr_idxx   = $_POST[ "ordr_idxx"   ];                  // 쇼핑몰 주문번호
    $buyr_name   = $_POST[ "buyr_name"   ];                  // 요청자 이름
    /* = -------------------------------------------------------------------------- = */
    $res_cd      = "";                                       // 결과 코드
    $res_msg     = "";                                       // 결과 메시지
    /* = -------------------------------------------------------------------------- = */
    $card_cd     = "";                                       // 카드 코드
    $batch_key   = "";                                       // 배치 인증키
    $card_mask_no = $_POST["card_mask_no"];                  // 카드번호             
    /* ============================================================================== */


    /* ============================================================================== */
    /* =   03. 인스턴스 생성 및 초기화                                              = */
    /* = -------------------------------------------------------------------------- = */
    $c_PayPlus = new C_PP_CLI;
    /* ============================================================================== */


    /* ============================================================================== */
    /* =   04. 처리 요청 정보 설정, 실행                                            = */
    /* = -------------------------------------------------------------------------- = */

    /* = -------------------------------------------------------------------------- = */
    /* =   04-1. 인증 요청                                                          = */
    /* = -------------------------------------------------------------------------- = */
    $c_PayPlus->mf_set_encx_data( $_POST[ "enc_data" ] , $_POST[ "enc_info" ] );

    /* = -------------------------------------------------------------------------- = */
    /* =   04-2. 실행                                                               = */
    /* = -------------------------------------------------------------------------- = */
    if ( $tran_cd != "" )
    {
            $c_PayPlus->mf_do_tx( $trace_no, $g_conf_home_dir, $g_conf_site_cd, "", $tran_cd, "",
                                  $g_conf_gw_url, $g_conf_gw_port, "payplus_cli_slib", $ordr_idxx,
                                  $cust_ip, "3" , 0, 0, $g_conf_log_path ); // 응답 전문 처리
    }
    else
    {
        $c_PayPlus->m_res_cd  = "9562";
        $c_PayPlus->m_res_msg = "연동 오류";
    }

    $res_cd    = $c_PayPlus->m_res_cd;
    $res_msg   = $c_PayPlus->m_res_msg;
    /* ============================================================================== */


    /* ============================================================================== */
    /* =   05. 인증 결과 처리                                                       = */
    /* = -------------------------------------------------------------------------- = */
    if( $res_cd == "0000" )
    {
        $card_cd   = $c_PayPlus->mf_get_res_data( "card_cd"   );
        $batch_key = $c_PayPlus->mf_get_res_data( "batch_key" );
    }
    /* ============================================================================== */


    /* ============================================================================== */
    /* =   06. 폼 구성 및 결과페이지 호출                                           = */
    /* ============================================================================== */
?>
    <html>
    <head>
    <script>
        function goResult()
        {
            document.pay_info.submit();
        }
    </script>
    </head>
    <body onload="goResult()">
    <form name="pay_info" method="post" action="./result.php">
        <input type="hidden" name="res_cd"      value="<?php echo $res_cd; ?>">            <!-- 결과 코드 -->
        <input type="hidden" name="res_msg"     value="<?php echo iconv("EUC-KR", "UTF-8", $res_msg); ?>">           <!-- 결과 메세지 -->
        <input type="hidden" name="ordr_idxx"   value="<?php echo $ordr_idxx; ?>">         <!-- 주문번호 -->
        <input type="hidden" name="buyr_name"   value="<?php echo $buyr_name; ?>">         <!-- 요청자 이름 -->
        <input type="hidden" name="card_cd"     value="<?php echo $card_cd; ?>">           <!-- 카드 코드 -->
        <input type="hidden" name="batch_key"   value="<?php echo $batch_key; ?>">         <!-- 배치 인증키 -->
        <input type="hidden" name="card_mask_no"   value="<?php echo $card_mask_no; ?>">         <!-- 카드번호 -->
    </form>
    </body>
    </html>
